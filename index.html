<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Path.io ‚Äì Proper GPS Tracker</title>

<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet"/>

<style>
body { margin:0; font-family:Arial,sans-serif; }
#map { position:absolute; inset:0; }

#info {
    position:absolute;
    top:10px; left:10px;
    background:white;
    padding:12px;
    border-radius:8px;
    box-shadow:0 2px 6px rgba(0,0,0,.25);
    z-index:2;
    width:280px;
    font-size:14px;
}

#info h3 { margin:0 0 8px; }

.stat { margin:4px 0; }

button {
    width:100%;
    margin-top:6px;
    padding:6px;
    cursor:pointer;
}

/* SVG marker container */
.gps-marker {
    width:32px;
    height:32px;
}
</style>
</head>
<body>

<div id="info">
    <h3>Path.io Tracker</h3>
    <div id="status">Waiting for GPS‚Ä¶</div>
    <div class="stat" id="time">‚è± Time: 0s</div>
    <div class="stat" id="distance">üìè Distance: 0 m</div>
    <div class="stat" id="speed">üöÄ Speed: 0 km/h</div>
    <div class="stat" id="heading">üß≠ Heading: ‚Äì</div>
    <button id="toggle">Pause Tracking</button>
</div>

<div id="map"></div>

<script>
/* ---------------- Map ---------------- */
const map = new maplibregl.Map({
    container: 'map',
    style: {
        version:8,
        sources:{
            osm:{
                type:'raster',
                tiles:[
                    'https://a.tile.openstreetmap.org/{z}/{x}/{y}.png',
                    'https://b.tile.openstreetmap.org/{z}/{x}/{y}.png',
                    'https://c.tile.openstreetmap.org/{z}/{x}/{y}.png'
                ],
                tileSize:256
            }
        },
        layers:[{ id:'osm', type:'raster', source:'osm' }]
    },
    center:[0,0],
    zoom:2
});

map.addControl(new maplibregl.NavigationControl(), 'top-right');

/* ---------------- State ---------------- */
let rawCoords = [];
let watchId = null;
let marker = null;
let tracking = true;

let lastPoint = null;
let totalDistance = 0;
let startTime = Date.now();

/* ---------------- Utils ---------------- */
function haversine(a, b) {
    const R = 6371000;
    const toRad = d => d * Math.PI / 180;
    const dLat = toRad(b.lat - a.lat);
    const dLon = toRad(b.lon - a.lon);

    const h =
        Math.sin(dLat/2)**2 +
        Math.cos(toRad(a.lat)) *
        Math.cos(toRad(b.lat)) *
        Math.sin(dLon/2)**2;

    return 2 * R * Math.asin(Math.sqrt(h));
}

function smooth(coords, windowSize = 5) {
    if (coords.length < windowSize) return coords;

    return coords.map((_, i) => {
        const slice = coords.slice(Math.max(0, i - windowSize + 1), i + 1);
        const avg = slice.reduce((a,c) => [a[0]+c[0], a[1]+c[1]], [0,0]);
        return [avg[0]/slice.length, avg[1]/slice.length];
    });
}

/* ---------------- SVG Marker ---------------- */
function createArrow() {
    const div = document.createElement('div');
    div.className = 'gps-marker';
    div.innerHTML = `
    <svg viewBox="0 0 100 100">
        <path d="M50 5 L90 95 L50 75 L10 95 Z"
              fill="#1976d2"/>
        <circle cx="50" cy="50" r="6" fill="white"/>
    </svg>`;
    return div;
}

/* ---------------- Map Load ---------------- */
map.on('load', () => {
    map.addSource('path', {
        type:'geojson',
        data:{ type:'Feature', geometry:{ type:'LineString', coordinates:[] } }
    });

    map.addLayer({
        id:'path-line',
        type:'line',
        source:'path',
        layout:{ 'line-join':'round', 'line-cap':'round' },
        paint:{ 'line-color':'#1976d2', 'line-width':4 }
    });

    startTracking();
});

/* ---------------- Tracking ---------------- */
function startTracking() {
    watchId = navigator.geolocation.watchPosition(pos => {
        if (!tracking) return;

        const { latitude, longitude, speed, heading } = pos.coords;
        const current = { lat: latitude, lon: longitude };

        if (lastPoint) {
            const d = haversine(lastPoint, current);
            if (d < 50) totalDistance += d; // noise filter
        }

        lastPoint = current;
        rawCoords.push([longitude, latitude]);

        const smoothed = smooth(rawCoords, 5);
        map.getSource('path').setData({
            type:'Feature',
            geometry:{ type:'LineString', coordinates: smoothed }
        });

        if (!marker) {
            marker = new maplibregl.Marker({
                element: createArrow(),
                rotationAlignment: 'map'
            })
            .setLngLat([longitude, latitude])
            .addTo(map);

            map.flyTo({ center:[longitude, latitude], zoom:16 });
        } else {
            marker.setLngLat([longitude, latitude]);
        }

        if (heading !== null) {
            marker.setRotation(heading);
            document.getElementById('heading').textContent =
                `üß≠ Heading: ${Math.round(heading)}¬∞`;
        }

        updateStats(speed);
    });
}

/* ---------------- UI ---------------- */
function updateStats(speed) {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);

    document.getElementById('time').textContent =
        `‚è± Time: ${elapsed}s`;

    document.getElementById('distance').textContent =
        `üìè Distance: ${totalDistance.toFixed(1)} m`;

    document.getElementById('speed').textContent =
        `üöÄ Speed: ${speed ? (speed * 3.6).toFixed(1) : 0} km/h`;

    document.getElementById('status').textContent = 'Tracking active';
}

document.getElementById('toggle').onclick = () => {
    tracking = !tracking;
    document.getElementById('toggle').textContent =
        tracking ? 'Pause Tracking' : 'Resume Tracking';
};
</script>

</body>
</html>